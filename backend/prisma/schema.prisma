// Prisma Schema for Milk Subscription Platform - MongoDB
// Version: 2.0.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  CUSTOMER
  ADMIN
  DELIVERY_PERSON
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SubscriptionFrequency {
  DAILY
  ALTERNATE
  WEEKDAYS
  WEEKENDS
  CUSTOM
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum DeliveryStatus {
  SCHEDULED
  OUT_FOR_DELIVERY
  DELIVERED
  PARTIAL
  MISSED
  FAILED
  CANCELLED
}

enum DeliveryType {
  REGULAR
  ADHOC
}

enum AdhocRequestStatus {
  PENDING
  APPROVED
  PARTIALLY_APPROVED
  REJECTED
  DELIVERED
  CANCELLED
  EXPIRED
}

enum BillStatus {
  DRAFT
  PENDING
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  ONLINE
  UPI
  CARD
  NETBANKING
  WALLET
  CASH
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum NotificationType {
  DELIVERY
  BILL
  PAYMENT
  SUBSCRIPTION
  VACATION
  ADHOC
  SYSTEM
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

// ==================== MODELS ====================

model User {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  email        String     @unique
  phone        String?
  passwordHash String     @map("password_hash")
  name         String
  role         UserRole   @default(CUSTOMER)
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // Relations
  customer      Customer?
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  token     String   @unique
  userId    String   @map("user_id") @db.ObjectId
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Customer {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @map("user_id") @db.ObjectId
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  addresses     Address[]
  subscriptions Subscription[]
  adhocRequests AdhocRequest[]
  deliveries    Delivery[]
  bills         Bill[]
  wallet        Wallet?
  notifications Notification[]

  @@map("customers")
}

model Address {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  customerId   String   @map("customer_id") @db.ObjectId
  label        String   @default("Home")
  addressLine1 String   @map("address_line1")
  addressLine2 String?  @map("address_line2")
  city         String
  state        String
  postalCode   String   @map("postal_code")
  country      String   @default("India")
  landmark     String?
  isDefault    Boolean  @default(false) @map("is_default")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  customer      Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  adhocRequests AdhocRequest[]
  deliveries    Delivery[]

  @@map("addresses")
}

model Product {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  description  String?
  unit         String   @default("liter")
  pricePerUnit Float    @map("price_per_unit")
  category     String   @default("MILK")
  imageUrl     String?  @map("image_url")
  minQuantity  Int      @default(1) @map("min_quantity")
  maxQuantity  Int      @default(10) @map("max_quantity")
  isAvailable  Boolean  @default(true) @map("is_available")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Embedded pricing history
  pricingHistory ProductPricing[]

  // Relations
  subscriptions Subscription[]
  adhocItems    AdhocItem[]
  deliveries    Delivery[]
  billItems     BillItem[]

  @@map("products")
}

// Embedded type for product pricing history
type ProductPricing {
  price     Float
  startDate DateTime @map("start_date")
  endDate   DateTime? @map("end_date")
}

model Subscription {
  id           String              @id @default(auto()) @map("_id") @db.ObjectId
  customerId   String              @map("customer_id") @db.ObjectId
  productId    String              @map("product_id") @db.ObjectId
  addressId    String              @map("address_id") @db.ObjectId
  quantity     Float
  frequency    SubscriptionFrequency @default(DAILY)
  customDays   Int[]               @default([]) @map("custom_days")
  deliverySlot String              @default("MORNING") @map("delivery_slot")
  startDate    DateTime            @map("start_date")
  endDate      DateTime?           @map("end_date")
  status       SubscriptionStatus  @default(ACTIVE)
  pausedFrom   DateTime?           @map("paused_from")
  pausedTo     DateTime?           @map("paused_to")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  // Embedded history
  history SubscriptionHistoryItem[]

  // Relations
  customer   Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id])
  address    Address    @relation(fields: [addressId], references: [id])
  vacations  Vacation[]
  deliveries Delivery[]

  @@map("subscriptions")
}

// Embedded type for subscription history
type SubscriptionHistoryItem {
  changeType  String
  oldValue    String?
  newValue    String?
  changedAt   DateTime @map("changed_at")
  changedBy   String?  @map("changed_by")
}

model Vacation {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  subscriptionId String   @map("subscription_id") @db.ObjectId
  startDate      DateTime @map("start_date")
  endDate        DateTime @map("end_date")
  reason         String?
  createdAt      DateTime @default(now()) @map("created_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@map("vacations")
}

model Holiday {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  date        DateTime @unique
  name        String
  description String?
  isRecurring Boolean  @default(false) @map("is_recurring")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("holidays")
}

model Delivery {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  customerId     String         @map("customer_id") @db.ObjectId
  subscriptionId String?        @map("subscription_id") @db.ObjectId
  adhocRequestId String?        @unique @map("adhoc_request_id") @db.ObjectId
  productId      String?        @map("product_id") @db.ObjectId
  addressId      String         @map("address_id") @db.ObjectId
  deliveryType   DeliveryType   @default(REGULAR) @map("delivery_type")
  deliveryDate   DateTime       @map("delivery_date")
  deliverySlot   String         @default("MORNING") @map("delivery_slot")
  quantity       Float
  pricePerUnit   Float          @map("price_per_unit")
  totalAmount    Float          @map("total_amount")
  status         DeliveryStatus @default(SCHEDULED)
  deliveredAt    DateTime?      @map("delivered_at")
  notes          String?
  issueReported  String?        @map("issue_reported")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relations
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])
  adhocRequest AdhocRequest? @relation(fields: [adhocRequestId], references: [id])
  product      Product?      @relation(fields: [productId], references: [id])
  address      Address       @relation(fields: [addressId], references: [id])

  @@index([deliveryDate, status])
  @@map("deliveries")
}

model AdhocRequest {
  id              String             @id @default(auto()) @map("_id") @db.ObjectId
  customerId      String             @map("customer_id") @db.ObjectId
  addressId       String             @map("address_id") @db.ObjectId
  deliveryDate    DateTime           @map("delivery_date")
  deliverySlot    String             @default("MORNING") @map("delivery_slot")
  status          AdhocRequestStatus @default(PENDING)
  totalAmount     Float              @default(0) @map("total_amount")
  notes           String?
  adminNotes      String?            @map("admin_notes")
  rejectionReason String?            @map("rejection_reason")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  customer Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  address  Address     @relation(fields: [addressId], references: [id])
  items    AdhocItem[]
  delivery Delivery?

  @@map("adhoc_requests")
}

model AdhocItem {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  adhocRequestId String  @map("adhoc_request_id") @db.ObjectId
  productId      String  @map("product_id") @db.ObjectId
  quantity       Float
  approvedQty    Float?  @map("approved_qty")
  pricePerUnit   Float   @map("price_per_unit")
  status         String  @default("PENDING")

  adhocRequest AdhocRequest @relation(fields: [adhocRequestId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id])

  @@map("adhoc_items")
}

model AdhocCapacity {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  date         DateTime @unique
  deliverySlot String   @map("delivery_slot")
  maxOrders    Int      @map("max_orders")
  currentCount Int      @default(0) @map("current_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([date, deliverySlot])
  @@map("adhoc_capacity")
}

model Bill {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  customerId  String     @map("customer_id") @db.ObjectId
  billNumber  String     @unique @map("bill_number")
  periodStart DateTime   @map("period_start")
  periodEnd   DateTime   @map("period_end")
  totalAmount Float      @map("total_amount")
  paidAmount  Float      @default(0) @map("paid_amount")
  status      BillStatus @default(PENDING)
  dueDate     DateTime   @map("due_date")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  customer Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items    BillItem[]
  payments Payment[]

  @@map("bills")
}

model BillItem {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  billId      String   @map("bill_id") @db.ObjectId
  productId   String?  @map("product_id") @db.ObjectId
  description String
  quantity    Float
  unitPrice   Float    @map("unit_price")
  totalPrice  Float    @map("total_price")
  createdAt   DateTime @default(now()) @map("created_at")

  bill    Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@map("bill_items")
}

model Payment {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  billId        String        @map("bill_id") @db.ObjectId
  amount        Float
  method        PaymentMethod
  transactionId String?       @map("transaction_id")
  status        PaymentStatus @default(PENDING)
  notes         String?
  paidAt        DateTime?     @map("paid_at")
  createdAt     DateTime      @default(now()) @map("created_at")

  bill Bill @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Wallet {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  customerId String   @unique @map("customer_id") @db.ObjectId
  balance    Float    @default(0)
  updatedAt  DateTime @updatedAt @map("updated_at")

  customer     Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@map("wallets")
}

model WalletTransaction {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  walletId    String          @map("wallet_id") @db.ObjectId
  type        TransactionType
  amount      Float
  description String
  reference   String?
  referenceId String?         @map("reference_id")
  createdAt   DateTime        @default(now()) @map("created_at")

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("wallet_transactions")
}

model Notification {
  id         String              @id @default(auto()) @map("_id") @db.ObjectId
  customerId String              @map("customer_id") @db.ObjectId
  type       NotificationType
  channel    NotificationChannel @default(IN_APP)
  title      String
  message    String
  isRead     Boolean             @default(false) @map("is_read")
  metadata   Json?
  createdAt  DateTime            @default(now()) @map("created_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId, isRead])
  @@map("notifications")
}

model AuditLog {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String?  @map("user_id") @db.ObjectId
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@map("audit_logs")
}

model SystemSetting {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  value     String
  type      String   @default("string")
  category  String   @default("general")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}
